CREATE TABLE IF NOT EXISTS `rig_maintenance_streams` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `rig_id` INT NOT NULL,
  `stream_name` VARCHAR(120) NOT NULL,
  `device_identifier` VARCHAR(120) DEFAULT NULL,
  `ingest_token_hash` CHAR(64) NOT NULL,
  `token_preview` VARCHAR(16) DEFAULT NULL COMMENT 'First characters of token for display',
  `allowed_metrics` JSON DEFAULT NULL,
  `status` ENUM('active','paused','revoked') DEFAULT 'active',
  `last_event_at` DATETIME DEFAULT NULL,
  `last_heartbeat_at` DATETIME DEFAULT NULL,
  `last_payload` JSON DEFAULT NULL,
  `created_by` INT DEFAULT NULL,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uniq_device` (`device_identifier`),
  KEY `idx_stream_rig` (`rig_id`),
  KEY `idx_stream_status` (`status`),
  CONSTRAINT `fk_stream_rig` FOREIGN KEY (`rig_id`) REFERENCES `rigs`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Telemetry ingest streams per rig';

CREATE TABLE IF NOT EXISTS `rig_telemetry_events` (
  `id` BIGINT AUTO_INCREMENT PRIMARY KEY,
  `rig_id` INT NOT NULL,
  `stream_id` INT DEFAULT NULL,
  `metric_key` VARCHAR(80) NOT NULL,
  `metric_label` VARCHAR(120) DEFAULT NULL,
  `metric_value` DECIMAL(16,4) DEFAULT NULL,
  `metric_unit` VARCHAR(24) DEFAULT NULL,
  `status` ENUM('normal','warning','critical') DEFAULT 'normal',
  `source` ENUM('telemetry','manual','import') DEFAULT 'telemetry',
  `recorded_at` DATETIME NOT NULL,
  `received_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `payload` JSON DEFAULT NULL,
  KEY `idx_events_rig_metric` (`rig_id`,`metric_key`,`recorded_at`),
  KEY `idx_events_stream` (`stream_id`,`recorded_at`),
  CONSTRAINT `fk_event_stream` FOREIGN KEY (`stream_id`) REFERENCES `rig_maintenance_streams`(`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_event_rig` FOREIGN KEY (`rig_id`) REFERENCES `rigs`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Raw rig telemetry events';

CREATE TABLE IF NOT EXISTS `rig_telemetry_thresholds` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `rig_id` INT NOT NULL,
  `stream_id` INT DEFAULT NULL,
  `metric_key` VARCHAR(80) NOT NULL,
  `metric_label` VARCHAR(120) DEFAULT NULL,
  `metric_unit` VARCHAR(24) DEFAULT NULL,
  `threshold_type` ENUM('greater_than','less_than','equals','delta') DEFAULT 'greater_than',
  `warning_threshold` DECIMAL(16,4) DEFAULT NULL,
  `critical_threshold` DECIMAL(16,4) DEFAULT NULL,
  `duration_minutes` INT DEFAULT NULL COMMENT 'Minimum duration to trigger an alert',
  `notes` TEXT DEFAULT NULL,
  `is_active` TINYINT(1) DEFAULT 1,
  `created_by` INT DEFAULT NULL,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uniq_metric_per_rig` (`rig_id`,`metric_key`),
  KEY `idx_threshold_stream` (`stream_id`),
  KEY `idx_threshold_active` (`is_active`),
  CONSTRAINT `fk_threshold_rig` FOREIGN KEY (`rig_id`) REFERENCES `rigs`(`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_threshold_stream` FOREIGN KEY (`stream_id`) REFERENCES `rig_maintenance_streams`(`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Metric thresholds for telemetry alerts';

CREATE TABLE IF NOT EXISTS `rig_maintenance_alerts` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `rig_id` INT NOT NULL,
  `stream_id` INT DEFAULT NULL,
  `metric_key` VARCHAR(80) DEFAULT NULL,
  `alert_type` ENUM('threshold','overdue','downtime','custom') DEFAULT 'threshold',
  `severity` ENUM('info','warning','critical') DEFAULT 'warning',
  `title` VARCHAR(180) NOT NULL,
  `message` TEXT NOT NULL,
  `status` ENUM('open','acknowledged','resolved') DEFAULT 'open',
  `trigger_value` DECIMAL(16,4) DEFAULT NULL,
  `threshold_value` DECIMAL(16,4) DEFAULT NULL,
  `triggered_at` DATETIME NOT NULL,
  `acknowledged_at` DATETIME DEFAULT NULL,
  `acknowledged_by` INT DEFAULT NULL,
  `resolved_at` DATETIME DEFAULT NULL,
  `resolved_by` INT DEFAULT NULL,
  `maintenance_record_id` INT DEFAULT NULL,
  `context_payload` JSON DEFAULT NULL,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  KEY `idx_alerts_rig_status` (`rig_id`,`status`,`severity`),
  KEY `idx_alerts_metric` (`metric_key`,`status`),
  CONSTRAINT `fk_alert_rig` FOREIGN KEY (`rig_id`) REFERENCES `rigs`(`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_alert_stream` FOREIGN KEY (`stream_id`) REFERENCES `rig_maintenance_streams`(`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='Active maintenance alerts generated by telemetry or schedules';

